# SUMMIT-blood-samples

## Deploy

### Requirements
* [docker-engine](https://docs.docker.com/engine/install/centos/)
* [docker-compose](https://docs.docker.com/compose/install/)

### Source
Deploy from **master** branch 

### Stack
* Django web app
* PostgreSQL database
* nginx reverse proxy
* pgAdmin 

### Setup
#### Config

***Production* environment**   
`$ mkdir -p summit_blood_samples/.envs/.production`  

Create `summit_blood_samples/.envs/.production/.django`  with

      # General
      # -----------------------------------------------
      USE_DOCKER=yes
      IPYTHONDIR=/app/.ipython
      DJANGO_SETTINGS_MODULE=config.settings.production
      DJANGO_SECRET_KEY=<super-secret-key>
      DJANGO_ALLOWED_HOSTS=<FQDN>
      DJANGO_SECURE_SSL_REDIRECT=[true|false]
      
      
Create `summit_blood_samples/.envs/.production/.postgres`  with 

    # PostgreSQL
    # ------------------------------------------------
    POSTGRES_HOST=postgres
    POSTGRES_PORT=5432
    POSTGRES_DB=summit_blood_samples
    POSTGRES_USER=<secret-username>
    POSTGRES_PASSWORD=<secret-password>
    
Create `summit_blood_samples/.envs/.production/.pgadmin`  with 

    # pgAdmin
    # ------------------------------------------------
    PGADMIN_DEFAULT_EMAIL=<admin user email>
    PGADMIN_DEFAULT_PASSWORD=<admin user password>
    
    
**Django settings:**  
Update `summit_blood_samples/config/settings/production.py`  

*Email*  

    EMAIL_BACKEND ='django.core.mail.backends.smtp.EmailBackend'
    EMAIL_HOST = '<smtp host>'
    EMAIL_HOST_USER = '<smtp user>'
    EMAIL_HOST_PASSWORD = '<smtp password>'
    EMAIL_PORT = 587
    EMAIL_USE_TLS = True
    EMAIL_FROM = 'Summit Blood Samples <email address>'
    DEFAULT_FROM_EMAIL = 'Summit Blood Samples <email address>'
    
    
#### Static files
The cookiecutter template seems set up for staticfiles to be served from a cloud based CDN.
This is not suitable and static files are to be served by the **nginx** container.  

The static files are generated by the **docker** container as part of its build process and copied to the *staticfiles* 
subdir on the host.
This directory is bind mounted to both the **django** and **nginx** containers.


#### Database
Get the full stack up & running from inside the *summit_blood_samples* dir with  
`$ docker-compose -f production.yml up --build`  
Then open a new terminal to initialise the database.

##### Migrations
`$ docker-compose -f production.yml run --rm django python manage.py makemigrations`

`$ docker-compose -f production.yml run --rm django python manage.py migrate`

##### Admin user

`$ docker-compose -f production.yml run --rm django python manage.py createsuperuser`

##### Initial data
The initial data that needs to be loaded includes the user Roles and the site's FQDN

Update `summit_blood_sampls/fixtures.json` with the FQDN as value for the "domain" key, then load with

`$ docker-compose -f production.yml run --rm django python manage.py loaddata fixtures.json`

***NB***: Once the superuser is created they need to be added to the ***Administrators*** role in the admin interface
at **/admin**    
Until this is done, an *Internal Error* will occur on any page loaded while the user is logged in.

##### pgAdmin
The pgAdmin interface is available on port **2345**  
Login with the *PGADMIN_DEFAULT_EMAIL* & *PGADMIN_DEFAULT_PASSWORD* credentials set above.  
Select **Add new server**  
In the *Create Server* dialog, enter **postgres** as the name and click on the *Connection* tab.  
Enter **postgres** as the host name and the *POSTGRES_USER* & *POSTGRES_PASSWORD* credentials from above
for the username & password fields.


### Build & Run
from inside the *summit_blood_samples* dir:  
`$ docker-compose -f production.yml up --build`

### Stop
`$ docker-compose -f production.yml down`

----
### Logs
`$ docker-compose -f production.yml logs -f`

-----
### Clean up
`$ docker-compose -f production.yml down --remove-orphans`

Add the *-v* flag at the end of the above statement to remove all volumes as well, USE WITH EXTREME CAUTION!  

-----

### Further docs

[cookiecutter Django on docker](http://cookiecutter-django.readthedocs.io/en/latest/deployment-with-docker.html)  
[Postgres on docker](https://docs.docker.com/engine/examples/postgresql_service/)  
[pgadmin on docker](https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html)  
[nginx on docker @ nginx](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-docker/)  
[nginx on docker @ docker](https://www.docker.com/blog/how-to-use-the-official-nginx-docker-image/)  
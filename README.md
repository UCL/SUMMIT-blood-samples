# SUMMIT-blood-samples

## Deploy

### Requirements
* [docker-engine](https://docs.docker.com/engine/install/centos/)
* [docker-compose](https://docs.docker.com/compose/install/)

### Source
Deploy from **master** branch 

### Setup
#### Config

***Production* environment**   
`$ mkdir -p summit_blood_samples/.envs/.production`  
Create `summit_blood_samples/.envs/.production/.django`  with

      # General
      # -----------------------------------------------
      USE_DOCKER=yes
      IPYTHONDIR=/app/.ipython
      DJANGO_SETTINGS_MODULE=config.settings.production
      DJANGO_SECRET_KEY=<super-secret-key>
 Create `summit_blood_samples/.envs/.production/.postgres`  with 

    # PostgreSQL
    # ------------------------------------------------
    POSTGRES_HOST=postgres
    POSTGRES_PORT=5432
    POSTGRES_DB=summit_blood_samples
    POSTGRES_USER=<secret-username>
    POSTGRES_PASSWORD=<secret-password>
    
**Django settings:**  
Update `summit_blood_samples/config/settings/base.py`  

    EMAIL_BACKEND ='django.core.mail.backends.smtp.EmailBackend'
    EMAIL_HOST = '<smtp host>'
    EMAIL_HOST_USER = '<smtp user>'
    EMAIL_HOST_PASSWORD = '<smtp password>'
    EMAIL_PORT = 587
    EMAIL_USE_TLS = True
    EMAIL_FROM = 'Summit Blood Samples <email address>'
    DEFAULT_FROM_EMAIL = 'Summit Blood Samples <email address>'
    
#### Static files
The cookie-cutter template seems set up for staticfiles to be served from a cloud based CDN.
This is not suitable and static files are to be served by the **nginx** container.  

The static files are generated by the **docker** container as part of its build process and copied to the *staticfiles* 
subdir on the host.
This directory is bind mounted to both the **django** and **nginx** containers.


#### Database
Get the full stack up & running from inside the *summit_blood_samples* dir with  
`$ docker-compose -f production.yml up --build`  
Then open a new terminal to initialise the database.

#### Migrations
`$ docker-compose -f production.yml run --rm django python manage.py makemigrations`

`$ docker-compose -f production.yml run --rm django python manage.py migrate`

#### Admin user

`$ docker-compose -f production.yml run --rm django python manage.py createsuperuser`

#### Initial data
The initial data that needs to be loaded includes the user Roles and the site's FQDN

Update `summit_blood_sampls/fixtures.json` with the FQDN as value for the "domain" key, then load with

`$ docker-compose -f production.yml run --rm django python manage.py loaddata fixtures.json`

**NB: Once the superuser is created they need to be added to the ***Administrators*** role in the admin interface

### Build & Run
from inside the *summit_blood_samples* dir:  
`$ docker-compose -f production.yml up --build`

### Stop
`$ docker-compose -f production.yml down`

-----
### Clean up
**NB: the *-v* option will remove all volumes as well - USE WITH CAUTION**  
`$ docker-compose -f production.yml down --remove-orphans  -v`

-----
